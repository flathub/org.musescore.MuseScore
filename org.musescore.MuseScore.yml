app-id:              org.musescore.MuseScore
branch:              beta

base:                io.qt.qtwebkit.BaseApp
base-version:        '5.11'

runtime:             org.kde.Platform
runtime-version:     '5.11'
sdk:                 org.kde.Sdk

command:             mscore
rename-desktop-file: mscore.desktop
rename-icon:         mscore

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland
  - --socket=wayland
  # MuseScore.com connectivity
  - --share=network
  # Note playback
  - --socket=pulseaudio
  # Jack Audio ...
  - --device=all
  # Allow loading/saving files from anywhere
  # (portals donâ€™t work yet)
  - --filesystem=host
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp

# From https://gitlab.com/freedesktop-sdk/freedesktop-sdk/blob/18.08/project.conf#L51
# Can be removed after switching to the 5.12 SDK
build-options:
  cflags: -O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches
  cxxflags: -O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches
  ldflags: -Wl,--as-needed,-z,relro,-z,now

cleanup-commands:
  # Cleanup after QtWebKit
  - rm -rf /app/include
  - rm -rf /app/lib/{cmake,mkspecs,pkgconfig}

modules:
  - shared-modules/lame/lame-3.99.5.json

  - name: jack2
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=/app --htmldir=/app/share/doc/jack/ --freebob=no --classic
      - python3 waf build
      - python3 waf install
    cleanup:
      - /bin
      - /include
      - /share
      - /lib/jack
      - /lib/libjackserver.so*
      - /lib/pkgconfig
    sources:
      - type: archive
        url: https://github.com/jackaudio/jack2/archive/v1.9.12.tar.gz
        sha512: f0271dfc8f8e2f2489ca52f431ad4fa420665816d6c67a01a76da1d4b5ae91f6dad8c4e3309ec5e0c159c9d312ed56021ab323d74bce828ace26f1b8d477ddfa

  - name: musescore
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=RELEASE
      - -DBUILD_PORTAUDIO=OFF
      - -DBUILD_PORTMIDI=OFF
      - -DBUILD_ALSA=OFF
      - -DBUILD_JACK=ON
      - -DUSE_SYSTEM_FREETYPE=ON
    build-commands:
      - make lrelease
    post-install:
      - mv /app/share/mime/packages/musescore.xml /app/share/mime/packages/org.musescore.MuseScore.xml
      - install -Dm644 -t /app/share/appdata org.musescore.MuseScore.appdata.xml
      # Add prefixes to mimetype icons so they can be exported
      # TODO: really, this bit could be nicer
      - cd /app/share/icons/hicolor;
        for d in */mimetypes/; do
          for f in ${d}*; do
            mv "$f" "${d}org.musescore.MuseScore.$(basename $f)";
          done;
        done
    sources:
      - type: archive
        url: https://github.com/musescore/MuseScore/archive/3.0beta2.zip
        sha256: 3f61fb455c1e782ff18c40c043554732a833e28c65b5f9f2cea5998c46c76ea5
      - type: patch
        path: musescore-mime-use-appid-icons.patch
      - type: file
        path: org.musescore.MuseScore.appdata.xml
