---
id: org.musescore.MuseScore
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk

command: mscore
rename-icon: mscore
copy-icon: true
rename-mime-file: musescore.xml
rename-mime-icons:
  - application-x-musescore
  - application-x-musescore+xml

finish-args:
  - --share=ipc
  - --socket=x11
  # MuseScore.com connectivity
  - --share=network
  - --socket=pulseaudio
  - --socket=cups
  - --device=dri
  # Allow loading/saving files from anywhere
  # (portals donâ€™t work yet)
  - --filesystem=home
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  - --filesystem=xdg-run/pipewire-0
  - --system-talk-name=org.freedesktop.UPower

add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
    directory: extensions/Plugins
    version: "24.08"
    add-ld-path: lib
    merge-dirs: vst3
    subdirectories: true
    no-autodownload: true

cleanup:
  - /share/man

modules:
  - name: musescore
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DMUSE_APP_BUILD_MODE=release
      - -DMUSE_ENABLE_UNIT_TESTS=OFF
      - -DMUSE_MODULE_VST=ON
      - -DMUSE_MODULE_VST_VST3_SDK_PATH=../vst3sdk
      - -DMUSE_MODULE_NETWORK_WEBSOCKET=ON
      # See: https://github.com/musescore/MuseScore/commit/696279e362afe72db5e92f8a47aa64b3a0e86a86
      - -DMUE_COMPILE_USE_SYSTEM_HARFBUZZ=ON
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - '*.a'
    post-install:
      - install -d /app/extensions/Plugins
      # https://github.com/hughsie/appstream-glib/blob/master/libappstream-glib/as-app-builder.c#L374
      - install -d /app/share/mscore
      - ln -s /app/share/mscore-4.6/locale /app/share/mscore/translations
    sources:
      - type: git
        url: https://github.com/steinbergmedia/vst3sdk.git
        tag: v3.7.12_build_20
        commit: cc2adc90382dded9e347caf74e4532f1458715db
        dest: vst3sdk
      - type: patch
        path: patches/vst3sdk_paths.patch
        options: 
          - --directory=vst3sdk
      - type: archive
        url: https://github.com/musescore/MuseScore/archive/refs/tags/v4.6.2.tar.gz
        sha256: 036275481bf8fe2af3010ec0cd20023b2ccc2ba35c31b6bc3ce4f95d0b601864
      - type: patch
        path: patches/musescore-fixes.patch
